<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* The professional dark theme styling remains the same */
    :root { --bg-color: #2C2C2C; --text-color: #FFFFFF; --text-color-secondary: #A0A0A0; --primary-color: #0D99FF; --primary-color-hover: #0B7DD9; --disabled-color: #555555; --border-color: #444444; --error-color: #FF6B6B; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
    .container { padding: 1rem; }
    .header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
    .header h1 { font-size: 1rem; font-weight: 600; margin: 0; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color-secondary); }
    select { width: 100%; padding: 0.5rem; background-color: #3E3E3E; color: white; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; }
    button { width: 100%; padding: 0.6rem; border: none; background-color: var(--primary-color); color: white; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
    .status { font-size: 0.8rem; color: var(--text-color-secondary); min-height: 20px; margin-top: 1rem; text-align: center; }
    a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>VisualBRD Exporter</h1>
    </div>

    <!-- The token input has been removed for simplicity -->

    <div class="form-group">
      <label for="project-select">Add to Project</label>
      <select id="project-select">
        <option value="">Loading projects...</option>
      </select>
    </div>

    <button id="export-button" disabled>Add Screen to Project</button>

    <p id="status" class="status"></p>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const exportButton = document.getElementById('export-button');
    const projectSelect = document.getElementById('project-select');

    // --- Hardcoded Token for Testing ---
    // 1. Use Postman to log in and get a valid JWT.
    // 2. Paste that token here.
    const apiToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGM5OTdhNTNmOWI3ZTFhNDk0MmZlNmQiLCJpYXQiOjE3NTg0NDg0MjUsImV4cCI6MTc2MTA0MDQyNX0.CjIIzfL_zCMuipcpJfRa4x24JOnXiSSX80vdWGcTMNY";

    // --- Core Plugin Logic (Receives messages from code.ts) ---
    window.onmessage = async (event) => {
      const { type, payload } = event.data.pluginMessage;
      if (type === 'EXPORT_RESULT') {
        const imageBlob = new Blob([payload], { type: 'image/png' });
        await uploadScreen(imageBlob);
      } else if (type === 'ERROR') {
        statusEl.innerHTML = `<span style="color: var(--error-color);">${payload.message}</span>`;
        exportButton.disabled = false;
      }
    };

    exportButton.onclick = () => {
      statusEl.textContent = 'Processing in Figma...';
      exportButton.disabled = true;
      parent.postMessage({ pluginMessage: { type: 'EXPORT_FRAME' } }, '*');
    };
    
    // --- Simplified Authentication Logic ---

    // Fetches projects using the hardcoded token.
    async function fetchProjects() {
      if (!apiToken || apiToken === "PASTE_YOUR_JWT_TOKEN_HERE") {
        statusEl.innerHTML = `<span style="color: var(--error-color);">Please set your JWT in the script.</span>`;
        return;
      }
      try {
        const response = await fetch('http://localhost:3000/api/v1/projects', {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Could not fetch projects.');
        }
        
        const projects = await response.json();
        if (projects.length === 0) {
            projectSelect.innerHTML = `<option value="">No projects found. Create one first.</option>`;
        } else {
            projectSelect.innerHTML = projects.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
            exportButton.disabled = false;
        }
      } catch (error) {
        statusEl.innerHTML = `<span style="color: var(--error-color);">${error.message}</span>`;
      }
    }
    
    // Uploads the screen using the hardcoded token.
    async function uploadScreen(blob) {
      const selectedProjectId = projectSelect.value;
      if (!selectedProjectId) {
        statusEl.innerHTML = `<span style="color: var(--error-color);">Please select a project.</span>`;
        exportButton.disabled = false;
        return;
      }

      try {
        statusEl.textContent = 'Uploading screen...';
        const formData = new FormData();
        formData.append('imageUrl', blob, 'figma-export.png');

        const response = await fetch(`http://localhost:3000/api/v1/screens/project/${selectedProjectId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiToken}` },
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Server error: ${response.status}`);
        }

        const newScreen = await response.json();
        statusEl.innerHTML = `Success! Screen '${newScreen.name}' added. <a href="http://localhost:3001/project/${newScreen.project}" target="_blank">View Project</a>`;
      } catch (error) {
        statusEl.innerHTML = `<span style="color: var(--error-color);">Error: ${error.message}</span>`;
      } finally {
        exportButton.disabled = false;
      }
    }
    
    // Fetch the user's projects as soon as the plugin UI loads.
    fetchProjects();
  </script>
</body>
</html>

